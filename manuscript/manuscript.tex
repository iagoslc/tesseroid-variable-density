%\documentclass[extra]{gji}
\documentclass[extra, referee]{gji}

\usepackage[utf8]{inputenc}
\usepackage{timet}
\usepackage{amsmath}
\usepackage{graphicx}

\usepackage{url}
\usepackage[pdftex,colorlinks=true]{hyperref}
\hypersetup{
    allcolors=blue,
}


\begin{document}

\title[Variable Density Tesseroids]{
    Gravitational field calculation in spherical coordinates using variable
    densities in depth
}
\author[S.R. Soler, A. Pesce, L. Uieda and M.E. Gimenez]{
    Santiago R. Soler$^{1,2}$, Agustina Pesce$^{1,2}$, Leonardo Uieda$^3$ and
    Mario E. Gimenez$^{1,2}$ \\
    $^1$CONICET, Argentina. e-mail: santiago.r.soler@gmail.com\\
    $^2$Instituto Geofísico Sismológico Volponi, Universidad Nacional de
    San Juan, Argentina\\
    $^3$Department of Earth Sciences, SOEST, University of Hawai‘i at
    M\={a}noa, Honolulu, Hawaii, USA
}


\maketitle

\begin{summary}
We present a new methodology to compute the gravitational fields generated by
tesseroids (spherical prisms) whose density varies with depth according to
an arbitrary continuous function.
It approximates the gravitational fields through the Gauss-Legendre Quadrature along
with two discretization algorithms that automatically control its accuracy by adaptively
dividing the tesseroid into smaller ones.
The first one is a preexisting two dimensional adaptive discretization algorithm that
reduces the errors due to the distance between the tesseroid and the computation point.
The second is a new density-based discretization algorithm that
decreases the errors introduced by the variation of the density function with depth.
The amount of divisions made by each algorithm is indirectly controlled
by two parameters: the distance-size ratio and the delta ratio.
We have obtained analytical solutions for a spherical shell with radially variable
density and compared them to the results of the numerical model for linear and
exponential density functions.
These comparisons allowed us to obtain optimum values for the distance-size and
delta ratios that yield an accuracy of 0.1\% of the analytical solutions.
The resulting optimal values of distance-size ratio for the gravitational potential, its
gradient, and Marussi tensor are 1, 2 and 8, respectively.
A delta ratio of 0.2 is needed for the computation of the gravitational potential and
its gradient components, while a value of 0.01 must be used for the Marussi tensor
components.
Lastly, we apply this new methodology to model the Neuqu\'en Basin, a foreland basin in
Argentina with a maximum depth of over 5000 m, using an exponential density function.
\end{summary}

\begin{keywords}
Numerical modelling, Numerical approximations and analysis, Gravity anomalies
and Earth structure, Satellite gravity
\end{keywords}


\section{Introduction}

The lithosphere's density variation with depth has been studied for close to a
century.
Over this time period,
several density-depth relations have been proposed for different rock types
\citep[e.g.,][]{Maxant1980, Rao1986, Rao1993, Rao1994}.
Furthermore, depth-variable densities have been used in forward and
inverse gravity modelling, mostly applied to sedimentary basins
\citep{Cordell1973, Rao1986, Cowie1990, Rao1993, Rao1994, Zhang2001,
Welford2010}.
These forward gravity models have been developed for two or three dimensional
bodies in Cartesian coordinates, which limits the applications to local scales.
The advent of satellite gravimetry has provided gravity field
measurements with global coverage, enabling modelling and interpretation on regional and
global scales.
Hence, designing forward modelling methods that reproduce the gravity anomalies for
such scales is of high importance.

To take into account the curvature of the Earth, many global forward modelling methods
are defined in geocentric spherical coordinates.
A common approach is to discretize the Earth into tesseroids (spherical prisms),
which are defined by pairs of latitude, longitude, and
radial boundaries (see Fig.~\ref{fig:tesseroid}).
The gravitational fields generated by an arbitrary
tesseroid on any external point are given by volume
integrals that must be numerically approximated.
The literature offers two main approaches: one involves Taylor series expansion
\citep{Heck2007, Grombein2013} while the other makes use of Gauss-Legendre
Quadrature (GLQ)
\citep{Asgharzadeh2007, Wild-Pfeiffer2008, Li2011, Uieda2016}.
The Taylor series expansion is not well suited to develop an algorithm for
a density varying with depth according to an arbitrary continuous function.
Different series expansion terms would have to obtained for each density function
desired.
Conversely, an arbitrary continuous density function can be included in the GLQ without
any change to the integration method.

\begin{figure}
\centering
\includegraphics[width=0.6\linewidth]{figures/tesseroid-uieda.pdf}
\caption{
    A tesseroid (spherical prism) in a geocentric spherical coordinate system, with a
    computation point $P$ and its local north oriented Cartesian coordinate system.
    After \citet{Uieda2015}.
}
\label{fig:tesseroid}
\end{figure}

The main challenge of the GLQ integration is loss of accuracy when the computation point
gets closer to the tesseroid \citep{Ku1977}.
\citet{Uieda2016} built on the three dimensional adaptive discretization algorithm of
\citet{Li2011} to automatically obtain integration results with 0.1\% accuracy.
The algorithm consist in recursively splitting the tesseroid into smaller ones when a
threshold is exceeded,
namely when the normalized distance to the computation point is greater than a
``distance-size ratio'' ($D$).
\citet{Uieda2016} have also obtained standard values of $D$
for the gravitational potential, its gradient and Marussi tensor components
by comparing the numerical model with the fields generated by a spherical shell.

Two recent papers present other approaches for homogeneous tesseroids gravitational
fields computation and incorporate methodologies for variable density tesseroid with
specific density profiles.
\citet{Fukushima2018} analytically integrates the volumetric integral for the
gravitational potential in the radial direction, obtaining a surface integral, which is
then numerically solved by applying a conditionally splitting and the double exponential
quadrature rule. The gradient of the potential and the Marussi tensor components are
then computed by finite differences. \citet{Fukushima2018} also generalizes his method
to an arbitrary polynomial density profile on the radial coordinate.
\citet{Lin2018} made a comparison of the different methodologies for homogeneous
tesseroid gravitational fields computation by applying different discretizations
algorithms to each one of them.
From this analysis they develop a combined method:
for computation points near the tesseroid they apply a GLQ numerical integration with
a two dimensional adaptive discretization algorithm, i.e. only in the horizontal
dimension. But, if the computation point is farther than a certain truncation distance,
then a second order Taylor series approximation is applied along with the regular
subdivision developed by \citet{Grombein2013}.
They also introduce a variation of their combined method to compute the gravitational
fields generated by tesseroids with linear density on the radial coordinate.

In summary, the bibliography is offering different methodologies for computing
gravitational fields of homogeneous tesseroids or with certain specific density
functions in depth.
Although any continuous density profile could be approximated by one of these specific
density functions, one should acknowledge the error that such approximation would
propagate into the gravitational field in order to guarantee certain degree of accuracy.

We present a new algorithm for computing the gravitational fields generated by any
tesseroid with any arbitrary continuous density function on any external point.
It is based on the three dimensional GLQ approximation, a two dimensional version of the
adaptive discretization of \citet{Uieda2016} and a new density-based discretization
algorithm that we introduce in this work.
In order to ensure the accuracy of the numerical approximation we have
determined optimal values for the controlling parameters by
comparing the numerical approximation with analytical solutions for
spherical shells.
Finally, we applied the methodology to model the Neuqu\'en basin, Argentina, using
tesseroids with linear and exponentially increasing density with depth.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Methodology}

Consider an arbitrary tesseroid in a geocentric spherical coordinate system defined by
pairs of geocentric latitudinal ($\phi_1$, $\phi_2$), longitudinal ($\lambda_1$,
$\lambda_2$) and radial ($r_1$, $r_2$) boundaries.
We define an external computation point $P(r, \phi, \lambda)$ located at radius $r$,
geocentric latitude $\phi$, and longitude $\lambda$ where the gravitational fields the
tesseroid generates are going to be calculated.
The first- and second-order derivatives of the gravitational potential are taken with
respect to the local north-oriented Cartesian coordinate system of $P$
(Fig.~\ref{fig:tesseroid}).
\citet{Grombein2013} provide efficient formulations for the volume integrals of the
gravitational potential and its first- and second-order derivatives of a tesseroid with
homogeneous density.
Here, we will assume that the tesseroid has a density varying with $r$ according to an
arbitrary continuous function $\rho(r)$.
Thus, the integrals for the gravitational fields are slightly modified to

\begin{equation}
    V(r,\phi,\lambda) = G
    \int\limits_{\lambda_1}^{\lambda_2}
    \int\limits_{\phi_1}^{\phi_2}
    \int\limits_{r_1}^{r_2}
    \frac{\rho(r')}{\ell} \kappa \,  dr' d\phi' d\lambda',
\label{eq:tesseroid-pot}
\end{equation}

\noindent and

\begin{equation}
    g_{\alpha}(r,\phi,\lambda) = G
    \int\limits_{\lambda_1}^{\lambda_2}
    \int\limits_{\phi_1}^{\phi_2}
    \int\limits_{r_1}^{r_2}
    \rho(r') \frac{\Delta_\alpha}{\ell^3}
    \kappa \, dr' d\phi' d\lambda',
\label{eq:tesseroid-grav}
\end{equation}

\noindent in which $\alpha, \beta \in \{x, y, z\}$, $\delta_{\alpha\beta}$ is
Kronecker's delta, $G = 6.674\times10^{-11}\, \text{m$^3$kg$^{-1}$s$^{-1}$}$ is the
gravitational constant and

\begin{equation}
    \Delta_x = r'[\cos\phi\sin\phi' - \sin\phi\cos\phi'
               \cos(\lambda' - \lambda)],
\end{equation}
\begin{equation}
    \Delta_y = r' \cos \phi' \sin(\lambda' - \lambda),
\end{equation}
\begin{equation}
    \Delta_z = r' \cos \psi - r,
\end{equation}
\begin{equation}
    \kappa = {r'}^2 \cos \phi',
\end{equation}
\begin{equation}
    \ell = \sqrt{{r'}^2 + r^2 - 2 r r' \cos \psi},
\label{eq:ell}
\end{equation}
\begin{equation}
    \cos\psi = \sin\phi\sin\phi' + \cos\phi\cos\phi'
                 \cos(\lambda' - \lambda).
\label{eq:cospsi}
\end{equation}

\subsection{Gauss-Legendre Quadrature integration}

Applying a $N$th order GLQ, we can approximate each integral in equations
\ref{eq:tesseroid-pot} and \ref{eq:tesseroid-grav} by a weighted sum of the integration
kernel evaluated on the roots of an $N$th order Legendre polynomial
\citep[p.~390]{Hildebrand1987}.
Unlike the homogeneous density case, the radial density function $\rho(r)$ must also be
included in the integration and evaluated on the Legendre polynomial roots (i.e.,
quadrature nodes).

\iftwocol{
\begin{equation}
    \begin{split}
        \int\limits_{\lambda_1}^{\lambda_2}
        \int\limits_{\phi_1}^{\phi_2}
        \int\limits_{r_1}^{r_2}
        \rho(r') f(r', \phi', \lambda')
        dr' d\phi' d\lambda' \approx& \\
        A
        \sum\limits_{i=1}^{N^r}
        \sum\limits_{j=1}^{N^\phi}
        \sum\limits_{k=1}^{N^\lambda}
        W_i^r W_j^\phi W_k^\lambda
        &\rho(r_i) f(r_i, \phi_j, \lambda_k),
    \end{split}
\label{eq:glq-var-dens}
\end{equation}
}{
\begin{equation}
    \int\limits_{\lambda_1}^{\lambda_2}
    \int\limits_{\phi_1}^{\phi_2}
    \int\limits_{r_1}^{r_2}
    \rho(r') f(r', \phi', \lambda')
    dr' d\phi' d\lambda' \approx
    A
    \sum\limits_{i=1}^{N^r}
    \sum\limits_{j=1}^{N^\phi}
    \sum\limits_{k=1}^{N^\lambda}
    W_i^r W_j^\phi W_k^\lambda \rho(r_i) f(r_i, \phi_j, \lambda_k),
\label{eq:glq-var-dens}
\end{equation}
}

\noindent where

\begin{equation}
    A =
    \frac{(\lambda_2 - \lambda_1)(\phi_2 - \phi_1)(r_2 - r_1)}{8},
\end{equation}

\noindent $f(r', \phi', \lambda')$ is the non-density dependent portion of the
integration kernels, $(r_i, \phi_j, \lambda_k)$ are the quadrature nodes, and
$W_i^r$, $W_j^\phi$, $W_k^\lambda$ are the quadrature weights.
The GLQ nodes and weights can be calculated as \citet[p.~391]{Hildebrand1987} (see
\citet{Uieda2016} for nodes and weights definitions on similar notation used on previous
equations).

It's worth noting that a GLQ is equivalent to approximate the tesseroid by $N^r \times
N^\phi \times N^\lambda$ point masses located on the quadrature nodes
\citep{Ku1977, Li2011, Uieda2016}.


\subsection{Two Dimensional Adaptive Discretization}

\citet{Ku1977} noticed that the GLQ integration
becomes less accurate when the computation point is closer to the
mass element.
One way to prevent this from happening would be to increase the GLQ order.
Doing so would uniformly increase the number of point masses inside the
tesseroid volume.
However, an increase in the point mass concentration is only required close to the
computation point \citep{Uieda2016}.
Alternatively, \citet{Li2011} proposed an adaptive
discretization algorithm which keeps the GLQ order fixed and divides the
tesseroid based on a ratio between the distance to the computation
point and its dimensions.
This algorithm produces a more efficient computation because an increased concentration
of point masses is produced where it is needed more.
\citet{Uieda2016} developed a modified version of this algorithm that speeds the
computation of the distances.
Both algorithms (the original one from \citet{Li2011} and the modified
version of \citet{Uieda2016}) perform tesseroid subdivisions in the latitudinal,
longitudinal and radial directions, thus we can define them as three dimensional
adaptive discretization algorithms.
On the other hand, \citet{Lin2018} proposed a two dimensional discretization algorithm
that subdivides the tesseroid only on the latitudinal and longitudinal directions.
Removing a dimension from the splitting makes the computation more efficient, while
keeping an acceptable accuracy on the gravitational fields \citep{Lin2018}.

Here we will use a two dimensional version of the adaptive discretization algorithm
developed by \citet{Uieda2016}: the distances from the tesseroid and the computation
point are computed as \citet{Uieda2016} do, but the tesseroid will only be split on the
longitudinal and latitudinal directions.
What follows is a summary of the algorithm and the reader is referred to
\citet{Uieda2016} for a detailed description.

Lets consider a computation point located at $(r, \phi, \lambda)$ and an arbitrary
tesseroid defined by the boundaries $r_1$, $r_2$, $\phi_1$, $\phi_2$, $\lambda_1$ and
$\lambda_2$, which geometric centre is located at $(r_t, \phi_t, \lambda_t)$, where

\begin{equation}
    r_t = \frac{r_2 + r_1}{2}, \quad
    \phi_t = \frac{\phi_2 + \phi_1}{2}, \quad
    \lambda_t = \frac{\lambda_2 + \lambda_1}{2}.
\end{equation}

We can define the longitudinal ($L_\lambda$) and latitudinal ($L_\phi$) dimensions of
the tesseroid as follows:

\begin{equation}
    L_\lambda = r_2 \arccos(\sin^2\phi_t +
        \cos^2\phi_t\cos(\lambda_2 - \lambda_1)),
    \label{eq:sizelon}
\end{equation}

\begin{equation}
    L_\phi = r_2 \arccos(\sin\phi_2\sin\phi_1 + \cos\phi_2\cos\phi_1).
\end{equation}

\textit{Step 1}: Check that the tesseroid satisfies the following inequality for each
dimension $L_i (i \in \{\lambda, \phi\})$ of the tesseroid:

\begin{equation}
    \frac{d}{L_i} \geq D,
    \label{eq:condition}
\end{equation}

\noindent
in which $D$ is a positive scalar called the distance-size ratio and $d$ is the distance
between the computation point and the geometric centre of the tesseroid

\begin{equation}
    d = \left[
        r^2 + r_t^2 - 2 r r_t \cos\psi_t
        \right]^{\frac{1}{2}} ,
    \label{eq:distance}
\end{equation}

\begin{equation}
    \cos\psi_t =
        \sin\phi\sin\phi_t + \cos\phi\cos\phi_t\cos(\lambda - \lambda_t) .
\end{equation}

\textit{Step 2}:
If none of the dimensions of the tesseroid fail inequality
\ref{eq:condition}, then compute the gravitational effect of the tesseroid using a
second-order GLQ (Eq. \ref{eq:glq-var-dens}).
Add the computed effect to a running total.

\textit{Step 3}:
If any dimension fails inequality \ref{eq:condition}, split the tesseroid in half along
the offending dimensions.
Repeat steps 1-3 for all smaller tesseroids until none are left.

\textit{Final step}:
By the end of the algorithm, a second-order GLQ will be applied on each small tesseroid
to compute the gravitational field they generate, and the sum of these results will be
the gravitational effect of the original tesseroid.

Notice that the distance-size ratio $D$ determines how many
times the tesseroids will be divided.
Therefore, it effectively regulates both the accuracy of the algorithm and its
computation time.
An optimal value for $D$ cannot be directly calculated from the desired accuracy level.
Instead, it is empirically determined by comparing the numerical results with the
analytical solution for a spherical shell.
\citet{Uieda2016} used a shell with homogeneous density to determine optimal values of
$D$.
Here, we will repeat the numerical experiment using analytical expressions for shells
with density varying according to certain functions of $r$.
This numerical experiment will also show that the two dimensional adaptive
discretization algorithm can achieve the same accuracy as the original three dimensional
version, though it reduces the number of tesseroid subdivisions and thus the computation
time.


\subsection{Density-based Discretization Algorithm}

\begin{figure*}
\centering
\includegraphics[width=\linewidth]
    {figures/density-based-discretization-algorithm.pdf}
\caption{
    Example application of the density-based discretization algorithm to a non-linear
    density function.
    (a) the normalised density function $\rho_n(r')$ (blue), current boundaries of the
    tesseroid (orange dots), and the linear density function $\rho_l(r')$ (orange line).
    The dashed red line represents the maximum density difference $\Delta \rho (r')$ at
    which the tesseroid would be divided (assuming that the inequality
    \ref{eq:delta-density} is not satisfied).
    (b) second iteration of the algorithm with a new linear density function and maximum
    density difference. The tesseroid would be divided at the depth indicated by the
    dashed red line.
    (c) third iteration of the algorithm.
    (d) final output of the density-based discretization, assuming that all four new
    tesseroids satisfy inequality \ref{eq:delta-density}.
}
\label{fig:density-discretization-algorithm}
\end{figure*}

The numerical integration of an arbitrary continuous density function introduces a new
type of problem: the integration error from using only a few nodes to account for the
variation of the density function.
The three dimensional adaptive discretization may help
to reduce this kind of error by adding more point masses in the radial direction.
However, it does not take into account the density function when subdividing the
tesseroid and hence it is not well suited to fully perform this task.
The two dimensional adaptive discretization algorithm does not subdivide the tesseroid
on the radial dimension, so it does not put any effort on lowering this new kind of
error.

We have developed a complementary discretization
algorithm that takes into account the variations of the density function.
This density-based discretization is applied prior to the adaptive discretization
described in the previous section.
In short, the algorithm divides the tesseroid along the radial dimension at the
depths at which the \emph{maximum density variations} take place.

Consider an \emph{original} tesseroid with a continuous density given by the function
$\rho(r')$.
Before the density-based discretization starts,
we normalise the density function to the range $[0, 1]$ as follows

\begin{equation}
    \rho_n(r') =
    \frac{\rho(r') - \rho_\text{min}}{\rho_\text{max} - \rho_\text{min}},
\end{equation}

\noindent in which $\rho_\text{min}$ and $\rho_\text{max}$ are the minimum and maximum
density values inside the tesseroid boundaries.
We emphasize that this normalised density function will not be modified throughout the
algorithm.
In case the density function is constant, both maximum and minimum densities will be
equal and the density-based discretization algorithm will not be applied.

The algorithm is comprised of the following steps
(Fig. \ref{fig:density-discretization-algorithm}):

\textit{Step 1}:
Define a linear function $\rho_l(r')$ that assumes
the same values as the normalised density $\rho_n(r')$ at the boundaries of the
tesseroid ($r_1$ and $r_2$):

\begin{equation}
    \rho_l(r') =
    \frac{ \rho_n(r_2) - \rho_n(r_1) }{ r_2 - r_1 } (r' - r_1) + \rho_n(r_1),
    \label{eq:density-reference-line}
\end{equation}

\textit{Step 2}:
Evaluate the normalized and linear density functions on a range of $N$ radii between
$r_1$ and $r_2$.
We have opted for $N = 101$ but the specific value of $N$ is not critical to the
algorithm.

\textit{Step 3}:
Compute the absolute difference between the values of the linear and normalised density
functions:

\begin{equation}
    \Delta \rho (r') = | \rho_n(r') - \rho_l(r') |.
    \label{eq:density-abs-diff}
\end{equation}

\textit{Step 4}:
If the following inequality holds, the tesseroid will not be divided:

\begin{equation}
    \text{max}\{ \Delta \rho(r') \} \frac{L_r}{L_r^\text{orig}} \le \delta,
    \label{eq:delta-density}
\end{equation}

\noindent
in which $L_r$ is the radial dimension of the tesseroid being considered for division,

\begin{equation}
    L_r = r_2 - r_1,
\end{equation}

\noindent $L_r^\text{orig}$ is the radial dimension of the original tesseroid, and
$\delta$ is a positive constant henceforth called the \textit{delta ratio}.

\textit{Step 5}:
If inequality \ref{eq:delta-density} is not satisfied, then the tesseroid is split in
two parts at the radius $r_\text{max}$ at which the maximum absolute difference (Eq.
\ref{eq:density-abs-diff}) takes place.

\textit{Step 6}:
Repeat steps 1-6 for each smaller tesseroid produced in step 5.

Once all smaller tesseroids satisfy Eq. \ref{eq:delta-density},
each one is subjected to the two dimensional adaptive
discretization algorithm described earlier to calculate their gravitational effects.

On the first iteration, the ratio $L_r/L_r^\text{orig} = 1$ because the tesseroid being
divided is the original one.
For further iterations, the ratio will be progressively smaller than one as the
tesseroids get smaller.
This is intended to limit the number of divisions to the ones that will
significantly reduce the numerical error:
dividing a large tesseroid with a small $\text{max}\{ \Delta \rho(r') \}$ would
improve the integration accuracy more than dividing a small tesseroid with a
higher $\text{max}\{ \Delta \rho(r') \}$.

The higher $\delta$ is, the fewer divisions will be made, and vice-versa.
Thus, it controls how many times the tesseroids will be divided based on the density
function and, indirectly, determines the accuracy and computation time of
numerical integration.
This raises the need to determine a maximum value of $\delta$ that
ensures an acceptable accuracy while minimising the computation time.


\subsection{Algorithm summary}

In summary, given any tesseroid with variable density in depth and an arbitrary
external computation point, we propose the following steps to numerically
compute the gravitational fields:

\textit{Step 1:}
Apply the density-based discretization algorithm.
It subdivides the tesseroid only in the radial dimension, thus it will return a set of
tesseroids with the same longitudinal and latitudinal dimensions as the original one but
with different radial boundaries.

\textit{Step 2:}
Apply the two dimensional adaptive discretization algorithm on each tesseroid obtained
in the previous step.
If needed, it will subdivide each tesseroid only in the latitudinal and longitudinal
direction, generating a set of smaller tesseroids that resemble the original one.

\textit{Step 3:}
Apply a second-order GLQ to numerically compute the gravitational fields
(Eq.\ref{eq:glq-var-dens}) generated by each tesseroid obtained in the
previous step.
Then sum these results in order to obtain the gravitational field of the original
tesseroid.


\subsection{Software implementation}

We have implemented the algorithms described in the previous sections in the Python
programming language.
The software is based on the pre-existing code for the homogeneous density tesseroid
\citep{Uieda2016}, more specifically the implementation in the Python library Fatiando a
Terra v0.5 \citep{Uieda2013}.
The more time consuming parts of the algorithm are written in the Cython language to
achieve higher performance.
This new code is freely available under the BSD 3-clause open-source license.
It can be downloaded from the online repository
\href{https://github.com/pinga-lab/tesseroid-variable-density}{github.com/pinga-lab/tesseroid-variable-density}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Determination of the distance-size and delta ratios}

The distance-size ratio $D$ of the adaptive discretization and the delta ratio $\delta$
of the density-based discretization determine how many times each tesseroid will be
divided and thus indirectly control the numerical error of the integration.
Optimal values for $D$ and $\delta$ must be determined in order to ensure both
acceptable numerical accuracy and computation efficiency for the algorithm.

\citet{Uieda2016} compared the numerical integration of homogeneous density tesseroids
with the analytical solution of a spherical shell \citep{Mikuska2006, Grombein2013} in
order to obtain default values for the distance-size ratio $D$.
We will follow this idea but for our needs the spherical shell must
have the same density function of radius as our tesseroid model.
\citet{Lin2018} show the analytical solution of the gravitational potential generated by
a spherical shell with linear density in the radial coordinate.
We derive an expression for such gravitational potential in case the spherical shell has
an arbitrary density function in depth (Eq. \ref{eq:shell-pot}), and obtained the
expressions in case of linear and exponential density (see Appendix \ref{sec:shell}).

We perform comparisons between the analytical solutions for the spherical shell and the
numerical integration results for linear, exponential and trigonometric density
functions.
From these results, we generalize default values for $D$ and $\delta$ that ensure a
numerical error lower than 0.1\% of the spherical shell values.

\begin{table}
\caption{
    Description of the tesseroid collections used to build a spherical shell and
    characterize the accuracy of the numerical integration.
    The first three columns describe the shapes of the tesseroid collections: each one
    specifies the number of tesseroids on the corresponding dimension (radial,
    latitudinal, longitudinal).
    The last two columns specify the latitudinal and longitudinal size of each
    tesseroid that compose the spherical shell model.
    For each collection, we define four spherical shell models with an outer radius
    equal to the mean Earth radius (6378.137 km) and the inner radius determined by the
    following thicknesses: 100m, 1km, 10km, 100km and 1000km.
}
\label{tab:tess-models}
\begin{tabular}{cccccc}
    Radial & Latitudinal & Longitudinal  & Total tesseroids & $L_\phi$ & $L_\lambda$
    \\ \hline
    1 & 1  & 2  & 2   & 180$^\circ$ & 180$^\circ$ \\
    1 & 6  & 12 & 72  &  30$^\circ$ &  30$^\circ$ \\
    1 & 12 & 24 & 288 &  15$^\circ$ &  15$^\circ$ \\
    1 & 18 & 36 & 648 &  10$^\circ$ &  10$^\circ$ \\
\end{tabular}
\end{table}

\begin{table}
\caption{
    Description of the computation grids used to characterize the accuracy of the
    numerical integration.
    Grid height is defined above the mean Earth radius.
}
\label{tab:grids}
\begin{tabular}{lccc}
    Name & Grid size & Grid region (degrees) & Grid height (km)
    \\ \hline
    Pole      & $0.1^\circ \times 0.1^\circ$ & 0E / 1E / 89N / 90N  & 0   \\
    Equator   & $0.1^\circ \times 0.1^\circ$ & 0E / 1E / 0N  / 1N   & 0   \\
    Global    & $ 10^\circ \times  10^\circ$ & 0E / 1E / 0N  / 1N   & 0   \\
    Satellite & $ 10^\circ \times  10^\circ$ & 0E / 1E / 89N / 90N  & 260 \\
\end{tabular}
\end{table}


\subsection{Linear Density}

A spherical shell with a linear density function given by

\begin{equation}
    \rho(r') = ar' + b,
    \label{eq:density-linear}
\end{equation}

\noindent
has an analytical solution given by Eq. \ref{eq:shell-pot-linear}.

The absolute density difference defined on equation
\ref{eq:density-abs-diff} will always be zero for the linear density case.
As a result, the inequality \ref{eq:delta-density} will always be satisfied and no
divisions will ever be performed.
Therefore, the two dimensional adaptive discretization algorithm is the
only mechanism that controls the accuracy of the numerical integration.
For this reason, we will only determine the minimum value of $D$ needed in order to
guarantee an acceptable accuracy while ignoring the value of $\delta$.

In order to compare the numerical results with the analytical solution we
must build spherical shell models made of tesseroids.
These shell models are determined by their inner and outer radii and by the collection
of tesseroids used to build the shell.
For this analysis we have chosen to set the outer radii of every shell model equal to
the mean Earth radius (6378.137 km), while the inner radius is determined by the desired
thickness of the shell.
We choose  different values of shell thickness (100m, 1km, 10km, 100km and 1000km) in
order to account for different computation scenarios.
Furthermore, we propose different tesseroids collections to build the shell model by
regularly splitting it along the longitudinal and latitudinal directions.
Each collection, described in Table~\ref{tab:tess-models}, is composed by a different
number of tesseroids, i.e. with tesseroids of different sizes.
Finally, for each collection we build a shell model with the thicknesses
previously described, giving a total of 20 different shell models.

The comparison between the numerical results and the analytical solution could be
naively compared on a single computation point due to the rotation symmetry of the
spherical shell.
But the numerical results may adopt different values depending on the relative location
between the computation point and the tesseroid, thus is not wise to carry out the
comparison on a single point.
Instead, we propose four computation grids detailed on Table~\ref{tab:grids}: a Pole and
an Equator grids, and a Global and Satellite grids.
The former ones are regional scale grids located on the outer surface of the spherical
shell, while the latter are global scale grids located at zero height (Global) and at
the mean orbital height of the gravimetric satellite missions (Satellite).
We define these grids in the spirit of span a broad scenario of gravitational field
computations and ensure an acceptable accuracy on each one of them.
The comparison will be carried out by computing the maximum absolute difference between
the analytical solution and the numerical result on each point of the computation grid.

We assign a density that varies linearly with $r$ (Eq.~\ref{eq:density-linear}) to each
shell, which assumes the values of $\rho_\text{in} = 3300$~kg/m$^3$ and
$\rho_\text{out} = 2670$~kg/m$^3$ on the inner and outer radii, respectively.
So, the constants $a$ and $b$ from Eq.~\ref{eq:density-linear} must be

\begin{equation}
    a = \frac{\rho_\text{out} - \rho_\text{in}}{R_\text{out} - R_\text{in}},
\end{equation}

\begin{equation}
    b = \rho_\text{out} -
    \frac{\rho_\text{out} - \rho_\text{in}}{R_\text{out} - R_\text{in}} R_\text{out},
\end{equation}

\noindent
where $R_\text{out}$ and $R_text{in}$ are the outer and inner radii of the shell,
respectively.
For every shell defined in Table~\ref{tab:tess-models}, the outer radius will be equal
to the mean Earth radius (6378.137 km).

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/linear-density-diffs.pdf}
\caption{
    Differences between the gravitational fields generated by each tesseroid shell model
    and the analytical solution.
    Each model has a linear density function of radius (Eq. \ref{eq:density-linear}).
    The computations were performed on the four combinations described in
    Table \ref{tab:grids}.
    Each line represents the maximum absolute difference between every shell model with
    a certain thickness.
    Due to the linearity of the density function, the density-based discretization
    algorithm is not applied.
    Differences are reported as a percentage of the shell values.
    The horizontal dashed black line represents a target difference of 0.1\%.
}
\label{fig:D-linear}
\end{figure*}

We compute the gravitational potential ($V$) and the vertical component of the gradient
($g_z$) that each shell model detailed on Table~\ref{tab:tess-models} generates on each
grid defined in Table~\ref{tab:grids}.
Other components of the gradient are equal to zero outside of the shell due to the
rotational symmetry and are thus omitted from the analysis.
The computations are repeated for values of $D$ ranging from 0.5 to 5 with a step of
0.5.
The differences are shown in Fig. \ref{fig:D-linear} as relative to the spherical shell
values.
We omit the differences for $g_{xx}$ and $g_{yy}$ because they are equivalent to the
ones obtained for $g_{zz}$.
Finally, we set the optimal value of $D$ as the minimum value at which the corresponding
error of the numerical approximation is lower than 0.1\%.

We observe from Fig. \ref{fig:D-linear} that the relative errors for the
potential and the $g_z$ component fall below the 0.1\% threshold at
$D=1$ and $D=2$, respectively, for both shell thicknesses.
On the other hand, $g_{zz}$ displays a noticeable
difference between the thin and the thick shell: the first one needs a
value of $D$ equal to 8 while the later only a $D$ of 3.

\subsection{Exponential Density}

For an exponential density function, the density-based discretization will be applied
before the adaptive discretization algorithm.
This means that optimal values for both the distance-size ratio $D$ and the delta ratio
$\delta$ must be determined.
We perform an error analysis similar to what was done for the linear density case.
However, we only consider the ``Big Grid'' from Table \ref{tab:grids} for the
sake of brevity.

The spherical shell and tesseroid model will have an exponential density function given
by

\begin{equation}
    \rho(r') = A e^{-(r' - R)/b} + C,
\label{eq:density-exp}
\end{equation}

\noindent where

\begin{equation}
    A =
    (3300 \text{kg/m}^3 - 2670 \text{kg/m}^3)
    \left( e^{( R - R_1 )/b} - 1 \right)^{-1},
\end{equation}

\begin{equation}
    C =
    2670 \text{kg/m}^3 - A,
\end{equation}

\noindent $R$ is the mean Earth radius, $R_1$ is the inner radius of the
shell (determined by the thickness), and $b$ is a constant that determines the
variability of the function: a low value of $b$ increases the maximum slope of the
density function.


\subsubsection{$D$-$\delta$ space exploration}

We aim to find a combination of the $D$ and $\delta$ that produces a numerical error
lower than the 0.1\% threshold while minimizing computation time.
We use a grid search method and compute the numerical error for every ($D$, $\delta$)
pair belonging to a grid on the $D$-$\delta$ space (Fig. \ref{fig:grid-search}).
Because this is a time consuming computation, we limit the analysis to a shell of 35 km
thickness and $b = 1\ \text{km}$ (Eq. \ref{eq:density-exp}), which yields a
sharp density variation within the shell.
For optimum algorithm performance, we search for the smallest possible value of $D$ and
the highest possible value of $\delta$.

We compute the relative difference between the numerical and analytical results for the
gravitational potential ($V$), the vertical component of its gradient ($g_z$), and the
$g_{zz}$ component of the Marussi tensor.
The results are shown in Fig. \ref{fig:grid-search}, in which points inside the dotted
lines are the ones that present a numerical error lower than the 0.1\% threshold.
Also shown in Fig. \ref{fig:grid-search} are the $D$ values determined for the linear
density function in the previous section ($D_\text{linear}$).
The values of $D_\text{linear}$ are within the 0.1\% threshold and are the optimum
values of $D$ for $V$ and $g_z$.
The results for $g_{zz}$ are in agreement with those obtained for the linear density
function in the case of a thick shell (Fig. \ref{fig:D-linear}).
Thus, we also choose the conservative value of $D=8$ as the optimum value for $g_{zz}$.
These results indicate that the values of $D_\text{linear}$ can be safely extrapolated
to the exponential case.

\begin{figure}
\centering
\iftwocol{
\includegraphics[width=0.9\linewidth]
    {figures/grid-search.pdf}
}{
\includegraphics[width=0.5\linewidth]
    {figures/grid-search.pdf}
}
\caption{
    Numerical error exploration in the $D$-$\delta$ space.
    The percentage difference values were obtained from the comparison
    between the analytical solution and the numerical approximation of
    the gravitational fields ($V$, $g_z$ and $g_{zz}$) generated by a
    spherical shell with an exponential density function (Eq. \ref{eq:density-exp}).
    These comparisons were carried out on the ``Big Grid'' (Table
    \ref{tab:grids}), with a spherical shell of
    35km of thickness, and density function with $b$ of 1km.
    The points inside the dashed line are the ones that present an
    error lower than 0.1\%.
    }
\label{fig:grid-search}
\end{figure}


\subsubsection{Delta ratio determination}

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/exponential-delta.pdf}
\caption{
    Numerical error for different exponential density functions and values of the delta
    ratio.
    The top panels show the exponential density functions for different values of $b$
    (Eq. \ref{eq:density-exp}).
    The error computations were performed on the ``Big Grid'' configuration described in
    Table \ref{tab:grids}, with fixed values of the distance-size ratio
    $D$ obtained for the linear density case ($D=1, 2, 8$ for the
    potential, gradient components, and Marussi tensor components, respectively).
    The difference is reported as a percentage of the shell values.
    }
\label{fig:delta-exponential}
\end{figure*}

Having chosen values of $D$ equal to the linear density case, we are free to explore the
integration error as a function of $\delta$ in more detail and how it varies for
different values of $b$ (Eq. \ref{eq:density-exp}).
We perform the error calculations for the ``Big Grid'' configuration (Table
\ref{tab:grids}) for two spherical shell models with 1km and 35km thickness.
The calculations are repeated for different values of $b$ to examine the error variation
with the sharpness of the density function.
Because larger $\delta$ values result in fewer tesseroid divisions,
our intention is to find the highest value of $\delta$ whose numerical error is bellow
the $0.1\%$ threshold.

Fig. \ref{fig:delta-exponential} shows the density functions and the resulting relative
differences ($V$, $g_z$, and $g_{zz}$) for different values of $b$ and thickness of the
shell and tesseroid model.
The relative difference for $V$ and $g_z$ falls below the 0.1\% threshold for
$\delta = 0.2$ in both the thick and thin shell cases.
On the other hand, optimal values of $\delta$ for $g_{zz}$
are $\delta = 0.2$ for the thin shell and $\delta = 0.01$ for the thick shell.
Once again, we opt for the conservative value of $\delta = 0.01$ and sacrifice
performance for the sake of accuracy.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Application to the Neuqu\'en Basin}

We applied the new algorithms and optimal values of $D$ and $\delta$ determined
previously to calculate the gravitational effects of the Neuqu\'en Basin:
a sedimentary basin
located to the east of the Andes, between 32$^\circ$S and 40$^\circ$S latitude
(Fig. \ref{fig:neuquen-basin}a).
The basin includes continental and marine siliciclastics, carbonates, and evaporites
accumulated over the Jurassic and the Cretaceous constituting a stratigraphic record up
to 5000m of depth \citep{Howell2005}.

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/neuquen-basin.pdf}
\caption{
    Gravitational effects of the Nequ\'en sedimentary basin modelled
    using tesseroids with an exponential density function of depth.
    (a) Topography of the Neuqu\'en Basin (in km) and its location in South America,
    (b) thickness of the sedimentary basin \citep[in meters;][]{Heine2007},
    (c) the exponential density function used to model the basin
        (depth in km and density in kg/m$^3$),
    (d)-(l) computed gravitational fields: potential $V$ (in J/kg), gradient
    components $g_x$, $g_y$ and $g_z$ (in mGal), and Marussi tensor components
    (in Eötvös), calculated at 50km of height over the ellipsoid.
}
\label{fig:neuquen-basin}
\end{figure*}

The thickness of the sediment pack was digitized from \citet{Heine2007} on a regular
grid with a resolution of 0.05$^\circ$ on both longitude and latitude directions
(Fig. \ref{fig:neuquen-basin}b).
We created a tesseroid model of the sediment pack by placing a
$0.05^\circ \times 0.05^\circ$ tesseroid on each node of the grid.
The top of each tesseroid was fixed at 0 m depth and the bottom at corresponding
thickness of the basin.

We must also define a density function for the tesseroid model.
\citet{Sigismondi2012} measured a minimum and maximum density contrast for
the Neuqu\'en basin of -412kg/m$^3$ and -275kg/m$^3$, respectively.
We have chosen an exponential density variation (Eq. \ref{eq:density-exp}) that assumes
the minimum value on the top surface and the maximum at 5858m depth (the thickest part
of the basin), with a value of $b$ equal to 2km.
This density function can be seen on Fig. \ref{fig:neuquen-basin}c.

Finally, we computed the gravitational potential $V$, gradient components $g_x$,
$g_y$ and $g_z$, and the Marussi tensor components $g_{xx}$, $g_{xy}$,
$g_{xz}$, $g_{yy}$, and $g_{zz}$ on a computation grid of $159\times163$ nodes
($0.05^\circ$ spacing on both longitude and latitude) at a 50km height over the
reference ellipsoid.
The resulting fields can be seen in Fig.
\ref{fig:neuquen-basin}d-l.
We have excluded the other components of the Marussi tensor from the Fig.
\ref{fig:neuquen-basin},
although they can be found in the online repository.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}

We have developed a new methodology to compute the gravitational fields
generated by a tesseroid with a density given by a continuous function of depth.
It numerically solves the integrals that define the gravitational potential,
its gradient, and the Marussi tensor components through the Gauss-Legendre
Quadrature (GLQ).
The accuracy of the numerical integration is automatically controlled by an adaptive
discretization algorithm and a new density-based discretization algorithm.
The former divides the tesseroid in half if the ratio of the distance to the computation
point and the size of the tesseroid is lower than a predefined distance-size ratio $D$.
This algorithm minimises the integration error when the computation point is close to
the tesseroid.
Nevertheless, the adaptive discretization alone is not sufficient to guarantee the
accuracy of the method in case of tesseroids with variable density.

To overcome this challenge, we have developed a density-based discretization algorithm
that divides the tesseroid on the points at which the maximum variations of the density
function take place.
The density-based discretization is performed before adaptive discretization as a type
of pre-processing step.
The number of divisions performed, and thus the accuracy of the computation, is
controlled by the delta ratio $\delta$.
This new algorithm is intended to minimise the error due to the inability of
the GLQ to produce precise approximations of density functions with sharp variations.

Because there is no direct relation between the values assigned to $D$ and $\delta$ and
the error of the computation, we empirically determined the optimum values for these
parameters.
These values minimize the computational load while maintaining the numerical error below
0.1\% of an analytical solution.
The density functions used to establish the optimum values were a linear and an
exponential function.
The linear function represents the smoothest variation of density and does not require
density-based discretization at all.
We analysed the error for exponential functions ranging from smooth to sharp variations
in depth to test the accuracy of the density-based discretization.
Through this analysis, we have obtained optimal values for the distance-size ratio of
1, 2 and 8 for the potential, its gradient, and the Marussi tensor components,
respectively.
These values are in agreement with previous results for a homogeneous density tesseroid
\citep{Uieda2016}.
The optimum $\delta$ values are 0.2 for the potential and its gradient components, while
a $\delta = 0.01$ must be used for the Marussi tensor components in order to ensure a
0.1\% precision.
A wide range of exponential functions were used to infer these results and they are
conservative estimates, chosen to prioritize accuracy over speed of computations.
Therefore, they can be safely generalized to other common depth-density relations, like
quadratic functions, without loss of accuracy.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Acknowledgments}

We are indebted to the developers and maintainers of the open-source software without
which this work would not have been possible.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\bibliographystyle{gji}
\bibliography{references}

\appendix

\section{Analytical Solutions for Spherical Shell}
\label{sec:shell}

\begin{figure}
\centering
\includegraphics[width=0.5\linewidth]{figures/spherical-shell.pdf}
\caption{
    Spherical shell with inner and outer radii $R_1$ and $R_2$, respectively.
    The computation point $Q$ is located on the $z$ axis at a distance $r$ from
    the origin of the coordinates system.
    For our purposes we will assume that $Q$ is outside of the shell,
    i.e. $r > R_2$.
}
\label{fig:spherical-shell}
\end{figure}

Consider a spherical shell with inner radius $R_1$ and outer radius $R_2$,
whose density is a function $\rho(r')$ of the radial coordinate
(Fig. \ref{fig:spherical-shell}).
The gravitational potential generated by the shell on an arbitrary external
point $Q$ can be written as follows:

\begin{equation}
    V_\text{sh}(\phi, \lambda, r) = G
    \int\limits_0^{2\pi}
    \int\limits_{-\frac{\pi}{2}}^\frac{\pi}{2}
    \int\limits_{R_1}^{R_2}
    \frac{\rho(r')}{\ell} {r'}^2 \cos\phi' \,
    dr' d\phi' d\lambda',
\end{equation}

\noindent where $\ell$ is defined in equation \ref{eq:ell}.

For $Q$ located along the $z$ axis (i.e., $\phi=90^\circ$) at a distance $r$ from the
origin, equation \ref{eq:ell} simplifies to:

\begin{equation}
    \ell = \sqrt{r'^2 + r^2 - 2 r r' \sin\phi'}.
\end{equation}

\noindent
Because of the rotational symmetry along the $z$ axis, the integration in $\lambda'$ is
straightforward:

\begin{equation}
    V_\text{sh}(r) = 2\pi G
    \int\limits_{-\frac{\pi}{2}}^\frac{\pi}{2}
    \int\limits_{R_1}^{R_2}
    \frac{\rho(r') {r'}^2 \cos\phi'}{\sqrt{r'^2 + r^2 - 2 r r' \sin\phi'}}
    \, dr' d\phi',
\end{equation}

\noindent
while the integration in $\phi'$ can be performed independently of the density function.
Making use of SymPy \citep{sympy2017}, a Python library for symbolic mathematics, we
obtained the following expression for the potential:

\iftwocol{
\begin{equation}
    \begin{split}
        V_\text{sh}(r) = 2\pi G
        \int\limits_{R_1}^{R_2}
        \Big[ & \sqrt{r^2 + r'^2 + 2rr'} - \\
        & \sqrt{r^2 + r'^2 - 2rr'}
        \Big] \frac{r'\rho(r')}{r} \, dr'.
    \end{split}
\label{eq:shell-pot-sqrts}
\end{equation}
}{
\begin{equation}
    V_\text{sh}(r) = 2\pi G
    \int\limits_{R_1}^{R_2}
    \Big[ \sqrt{r^2 + r'^2 + 2rr'}  -
    \sqrt{r^2 + r'^2 - 2rr'}
    \Big] \frac{r'\rho(r')}{r} \, dr'.
\label{eq:shell-pot-sqrts}
\end{equation}
}

Because the computation point $Q$ is outside of the shell, $r > r'$ and the square roots
in equation \ref{eq:shell-pot-sqrts} simplify to

\begin{equation}
    \sqrt{r^2 + r'^2 + 2rr'} = |r + r'| = r + r',
\end{equation}

\begin{equation}
    \sqrt{r^2 + r'^2 - 2rr'} = |r - r'| = r - r',
\end{equation}

\noindent which leads to the following expression for the potential:

\begin{equation}
    V_\text{sh}(r) = \frac{4\pi G}{r}
    \int\limits_{R_1}^{R_2} {r'}^2 \rho(r') \, dr'.
\label{eq:shell-pot}
\end{equation}

The gradient and the Marussi tensor of potentials that
depends solely on $r$ have only a few non zero components: the vertical
component of the gradient ($g_z$) and the diagonal components of the
tensor ($g_{xx}$, $g_{yy}$, $g_{zz}$).
Following \citet{Grombein2013}:

\begin{equation}
    g_z(r) = \frac{V_\text{sh}(r)}{r},
\end{equation}

\begin{equation}
    g_{xx}(r) = g_{yy}(r) = -\frac{V_\text{sh}(r)}{r^2},
\end{equation}

\begin{equation}
    g_{zz}(r) = \frac{2V_\text{sh}(r)}{r^2}.
\end{equation}

From Eq. \ref{eq:shell-pot} we can obtain expressions of the gravitational potential for
different density functions.

\subsection{Linear density}

For a linear density function

\begin{equation}
    \rho(r') = ar' + b\ ,
\end{equation}

\noindent
the gravitational potential at any external point is

\begin{equation}
    V_\text{sh}^\text{lin}(r) = \pi G \left[
    a \frac{R_2^4 - R_1^4}{r} +
    b \,\frac{4}{3} \frac{R_2^3 - R_1^3}{r} \right].
    \label{eq:shell-pot-linear}
\end{equation}

\noindent The first term on this equation reproduces the potential generated
by a spherical shell with variable density $\rho(r') = ar'$, while the second
term constitutes the potential generated by a spherical shell with homogeneous
density $\rho = b$ \citep{Mikuska2006,Grombein2013}.

\subsection{Exponential density}

For an exponential density function

\begin{equation}
    \rho(r') = A e^{- k (r' - R)},
\end{equation}

\noindent
where $A$, $k$ and $R$ are constants, the gravitational potential on any external point
is

\begin{equation}
    \begin{split}
    V_\text{exp}(r) = \frac{4\pi G}{r} \frac{A}{k^3} \Big[
    & \left( R_1^2 k^2 + 2 R_1 k + 2 \right) e^{- k (R_1 - R)} - \\
    & \left( R_2^2 k^2 + 2 R_2 k + 2 \right) e^{- k (R_2 - R)}
    \Big].
    \end{split}
\end{equation}

Moreover, an exponential density function that assumes the values of $\rho_\text{out}$
and $\rho_\text{in}$ on the shell's outer and inner surfaces, respectively, can be
defined as follows:

\begin{equation}
    \rho(r') = A e^{- \frac{b}{T} (r' - R)} + C,
\end{equation}

\noindent where

\begin{equation}
    A = \frac{\rho_\text{in} - \rho_\text{out}}{D},
\end{equation}

\begin{equation}
    C = \frac{1}{D}
    \left[\rho_\text{out} \, e^{- \frac{b}{T} (R_1 - R)} -
    \rho_\text{in} \, e^{- \frac{b}{T} (R_2 - R)} \right],
\end{equation}

\begin{equation}
    D = e^{- \frac{b}{T} (R_1 - R)} - e^{- \frac{b}{T} (R_2 - R)},
\end{equation}

\noindent $R$ is the mean Earth radius, $T$ is the thickness of the shell ($T = R_2
- R_1$) and $b$ is a dimensionless constant that determines the variability of the
function: a high value of $b$ increases the maximum slope of the density function.

The analytical solution of the gravitational potential generated by a
spherical shell with such density function is

\begin{equation}
    \begin{split}
        V_\text{exp}(r) = & \frac{4\pi G}{r} \frac{A T^3}{b^3} \\ \Big[
        & \left( \left( b R_1/T \right)^2 + 2 b R_1/T + 2 \right)
        e^{- \frac{b}{T} (R_1 - R)} - \\
        & \left( \left( b R_2/T \right)^2 + 2 b R_2/T + 2 \right)
        e^{- \frac{b}{T} (R_2 - R)}
        \Big] + \\
        & \frac{4\pi G}{3 r} C \left( R_2^3 - R_1^3 \right).
    \end{split}
\label{eq:shell-pot-exp}
\end{equation}

\end{document}

